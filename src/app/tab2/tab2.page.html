<ion-header [translucent]="true">
  <ion-toolbar color="success">
    <ion-title>
      <div class="header-content">
        <div class="header-left">
          <strong>AGRODATA</strong>
        </div>
        <div class="header-right">
          <span>RANCHO LA VAQUITA FELIZ</span>
          <span class="animal-count">{{ totalAnimals }} ANIMALES</span>
          <ion-icon name="log-out-outline" (click)="logout()" class="logout-btn"></ion-icon>
        </div>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="animals-content">
  <!-- Contenedor principal con bordes redondeados -->
  <div class="main-container">
    
    <!-- Barra de búsqueda y filtros -->
    <div class="search-section">
      <div class="search-row">
        <ion-searchbar 
          placeholder="Buscar por ID, SINIGA o Nombre"
          (ionInput)="onSearchChange($event)" 
          [value]="searchTerm"
          class="custom-searchbar">
        </ion-searchbar>
        
        <ion-button 
          [fill]="selectedSexFilter === 'Todos' ? 'solid' : 'outline'"
          [color]="selectedSexFilter === 'Todos' ? 'primary' : 'medium'"
          class="filter-button"
          (click)="onSexFilterChange('Todos')">
          Todos
        </ion-button>
        
        <ion-button 
          color="success" 
          class="add-button" 
          (click)="openAddModal()">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          AGREGAR
        </ion-button>
      </div>
    </div>

    <!-- Filtros de sexo -->
    <div class="sex-filters">
      <ion-button 
        [fill]="selectedSexFilter === 'Hembra' ? 'solid' : 'outline'"
        [color]="selectedSexFilter === 'Hembra' ? 'success' : 'medium'"
        (click)="onSexFilterChange('Hembra')"
        class="sex-filter-btn">
        <ion-icon name="female-outline" slot="start"></ion-icon>
        Hembras ({{ totalHembras }})
      </ion-button>
      
      <ion-button 
        [fill]="selectedSexFilter === 'Macho' ? 'solid' : 'outline'"
        [color]="selectedSexFilter === 'Macho' ? 'tertiary' : 'medium'"
        (click)="onSexFilterChange('Macho')"
        class="sex-filter-btn">
        <ion-icon name="male-outline" slot="start"></ion-icon>
        Machos ({{ totalMachos }})
      </ion-button>
    </div>

    <!-- Tabla de animales -->
    <div class="table-container">
      <!-- Header de la tabla -->
      <div class="table-header">
        <div class="header-cell">ID</div>
        <div class="header-cell">SINIGA</div>
        <div class="header-cell">Nombre</div>
        <div class="header-cell">Madre</div>
        <div class="header-cell">Padre</div>
        <div class="header-cell">F. Nacimiento</div>
        <div class="header-cell">Edad</div>
        <div class="header-cell">Estado</div>
        <div class="header-cell">Sexo</div>
        <div class="header-cell action-cell">Acciones</div>
      </div>

      <!-- Cuerpo de la tabla -->
      <div class="table-body">
        <div *ngFor="let animal of filteredAnimals" class="table-row">
          <div class="body-cell">{{ animal.id }}</div>
          <div class="body-cell">{{ animal.siniga }}</div>
          <div class="body-cell">{{ animal.nombre }}</div>
          <div class="body-cell">{{ animal.madre || '-' }}</div>
          <div class="body-cell">{{ animal.padre || '-' }}</div>
          <div class="body-cell">{{ formatDate(animal.fechaNacimiento) }}</div>
          <div class="body-cell">{{ animal.edad }}</div>
          <div class="body-cell">
            <ion-badge [color]="getStatusColor(animal.estado)" class="status-badge">
              {{ animal.estado }}
            </ion-badge>
          </div>
          <div class="body-cell">
            <ion-badge [color]="animal.sexo === 'Hembra' ? 'danger' : 'primary'">
              {{ animal.sexo }}
            </ion-badge>
          </div>
          <div class="body-cell action-cell">
            <ion-button size="small" fill="clear" color="primary" (click)="openEditModal(animal); $event.stopPropagation()">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" color="danger" (click)="confirmDelete(animal); $event.stopPropagation()">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Mensaje cuando no hay resultados -->
      <div *ngIf="filteredAnimals.length === 0" class="no-results">
        <ion-icon name="search-outline"></ion-icon>
        <h3>No se encontraron animales</h3>
        <p>Intenta cambiar los filtros de búsqueda</p>
      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar animal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="success">
          <ion-title>{{ isEditMode ? 'Editar Animal' : 'Registrar Animal' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="modal-content">
        <div class="form-container">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">ID *</ion-label>
                  <ion-input 
                    [value]="currentAnimal.id" 
                    type="text" 
                    readonly
                    placeholder="Generado automáticamente">
                  </ion-input>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">SINIGA *</ion-label>
                  <ion-input
                    [(ngModel)]="currentAnimal.siniga"
                    type="text"
                    placeholder="Ingrese el SINIGA"
                    required>
                  </ion-input>
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="12">
                <ion-item>
                  <ion-label position="stacked">Nombre *</ion-label>
                  <ion-input 
                    [(ngModel)]="currentAnimal.nombre" 
                    placeholder="Nombre del animal"
                    required>
                  </ion-input>
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Madre</ion-label>
                  <ion-input 
                    [(ngModel)]="currentAnimal.madre" 
                    placeholder="Nombre de la madre">
                  </ion-input>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Padre</ion-label>
                  <ion-input 
                    [(ngModel)]="currentAnimal.padre" 
                    placeholder="Nombre del padre">
                  </ion-input>
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Fecha de Nacimiento *</ion-label>
                  <ion-input 
                    type="date"
                    [(ngModel)]="currentAnimal.fechaNacimiento"
                    (ionChange)="onBirthDateChange()"
                    required>
                  </ion-input>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Sexo *</ion-label>
                  <ion-select [(ngModel)]="currentAnimal.sexo" required>
                    <ion-select-option value="Hembra">Hembra</ion-select-option>
                    <ion-select-option value="Macho">Macho</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Estado *</ion-label>
                  <ion-select [(ngModel)]="currentAnimal.estado" required>
                    <ion-select-option value="Excelente">Excelente</ion-select-option>
                    <ion-select-option value="Bueno">Bueno</ion-select-option>
                    <ion-select-option value="Regular">Regular</ion-select-option>
                    <ion-select-option value="Enfermo">Enfermo</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item>
                  <ion-label position="stacked">Peso (kg)</ion-label>
                  <ion-input 
                    type="number"
                    [(ngModel)]="currentAnimal.peso" 
                    placeholder="0"
                    min="0">
                  </ion-input>
                </ion-item>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="12">
                <ion-item>
                  <ion-label position="stacked">Observaciones</ion-label>
                  <ion-textarea 
                    [(ngModel)]="currentAnimal.observaciones" 
                    placeholder="Observaciones adicionales..."
                    rows="3">
                  </ion-textarea>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>

          <div class="modal-buttons">
            <ion-button 
              expand="block" 
              color="medium" 
              (click)="closeModal()">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancelar
            </ion-button>
            <ion-button 
              expand="block" 
              color="success" 
              (click)="saveAnimal()"
              [disabled]="!validateAnimal()">
              <ion-icon name="save-outline" slot="start"></ion-icon>
              {{ isEditMode ? 'Actualizar' : 'Registrar' }}
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal para eliminar animal -->
  <ion-modal [isOpen]="isDeleteModalOpen" (didDismiss)="closeDeleteModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="danger">
          <ion-title>Eliminar Animal</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeDeleteModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-content">
        <div class="form-container">
          <ion-item>
            <ion-label position="stacked">Animal a eliminar</ion-label>
            <ion-input 
              [value]="animalToDelete?.nombre + ' (' + animalToDelete?.id + ')'" 
              readonly>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Razón de eliminación *</ion-label>
            <ion-select [(ngModel)]="deleteReason" placeholder="Selecciona la razón" required>
              <ion-select-option value="Venta">Venta</ion-select-option>
              <ion-select-option value="Muerte">Muerte</ion-select-option>
              <ion-select-option value="Traslado">Traslado a otro rancho</ion-select-option>
              <ion-select-option value="Error">Registro duplicado o erróneo</ion-select-option>
              <ion-select-option value="Otro">Otro motivo</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item *ngIf="deleteReason === 'Otro'">
            <ion-label position="stacked">Especificar motivo *</ion-label>
            <ion-textarea
              [(ngModel)]="customDeleteReason"
              placeholder="Describe el motivo de la eliminación..."
              rows="3"
              required>
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Observaciones adicionales</ion-label>
            <ion-textarea
              [(ngModel)]="deleteObservations"
              placeholder="Observaciones adicionales sobre la eliminación..."
              rows="2">
            </ion-textarea>
          </ion-item>

          <div class="modal-buttons">
            <ion-button expand="block" color="medium" (click)="closeDeleteModal()">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancelar
            </ion-button>
            <ion-button expand="block" color="danger" (click)="deleteAnimal()" [disabled]="!canDelete()">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              Confirmar Eliminación
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>